{% extends 'base.html' %}
{% block content %}
<h2 class="text-3xl font-bold mb-6 text-center text-green-700">Zoomable TreeMap of Singers</h2>
<div id="treemap" class="flex justify-center overflow-auto"></div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const data = {{ data | safe }};
const width = 960;
const height = 600;
const format = d3.format(",d");
const color = d3.scaleOrdinal(d3.schemeTableau10);

const svg = d3.select("#treemap")
  .append("svg")
  .attr("viewBox", [0, 0, width, height])
  .style("font-family", "sans-serif")
  .style("font-size", "11px");

const tooltip = d3.select("body").append("div")
  .style("position", "absolute")
  .style("background", "#111")
  .style("color", "#fff")
  .style("padding", "6px 8px")
  .style("font-size", "12px")
  .style("border-radius", "4px")
  .style("pointer-events", "none")
  .style("opacity", 0);

const root = d3.hierarchy(data).sum(d => d.value).sort((a, b) => b.value - a.value);
const treemap = d3.treemap().size([width, height]).padding(2).round(true);
treemap(root);

let currentRoot = root;
render(currentRoot);

function render(root) {
  svg.selectAll("g").remove(); // Clean up previous render
  const group = svg.append("g");

  const nodes = group.selectAll("g")
    .data(root.children)
    .join("g")
    .attr("transform", d => `translate(${d.x0},${d.y0})`);

  nodes.append("rect")
    .attr("fill", d => color(d.depth))
    .attr("width", d => d.x1 - d.x0)
    .attr("height", d => d.y1 - d.y0)
    .attr("rx", 5)
    .attr("ry", 5)
    .on("mouseover", (event, d) => {
      tooltip.transition().duration(200).style("opacity", 0.95);
      tooltip.html(`<strong>${d.data.name}</strong><br>${d.value ? `Popularity: ${format(d.value)}` : ''}`);
    })
    .on("mousemove", event => {
      tooltip.style("left", (event.pageX + 15) + "px").style("top", (event.pageY - 10) + "px");
    })
    .on("mouseout", () => {
      tooltip.transition().duration(200).style("opacity", 0);
    })
    .on("click", (event, d) => {
      if (d.children) zoomIn(d);
    });

  nodes.append("text")
    .attr("x", 6)
    .attr("y", 14)
    .text(d => {
      const boxWidth = d.x1 - d.x0;
      const name = d.data.name;
      return name.length > 20 ? name.slice(0, 17) + "..." : name;
    })
    .attr("fill", "#fff")
    .style("pointer-events", "none");
}

function zoomIn(d) {
  currentRoot = d;
  treemap(currentRoot); // recalculate layout
  const t = svg.transition().duration(750);
  render(currentRoot);
}
</script>

{% endblock %}

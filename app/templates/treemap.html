{% extends 'base.html' %}
{% block content %}
<h2 class="text-3xl font-bold mb-6 text-center text-green-700">Zoomable TreeMap of Singers</h2>
<div id="treemap" class="flex justify-center overflow-auto"></div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const data = {{ data | safe }};
const width = 960;
const height = 600;
const format = d3.format(",d");
const color = d3.scaleOrdinal(d3.schemeTableau10);

const svg = d3.select("#treemap")
  .append("svg")
  .attr("viewBox", [0, 0, width, height])
  .style("font-family", "Inter, sans-serif")
  .style("font-size", "12px");

const tooltip = d3.select("body").append("div")
  .style("position", "absolute")
  .style("background", "#111")
  .style("color", "#fff")
  .style("padding", "6px 8px")
  .style("font-size", "12px")
  .style("border-radius", "4px")
  .style("pointer-events", "none")
  .style("opacity", 0);

const root = d3.hierarchy(data).sum(d => d.value).sort((a, b) => b.value - a.value);
const treemap = d3.treemap().size([width, height]).paddingInner(3).round(true);
treemap(root);

let currentRoot = root;
render(currentRoot);

function render(root) {
  svg.selectAll("g").remove();

  const group = svg.append("g");
  const nodes = group.selectAll("g")
    .data(root.children)
    .join("g")
    .attr("transform", d => `translate(${d.x0},${d.y0})`);

  nodes.append("rect")
    .attr("fill", d => color(d.ancestors().map(d => d.data.name).join("/")))
    .attr("width", d => d.x1 - d.x0)
    .attr("height", d => d.y1 - d.y0)
    .attr("rx", 6)
    .attr("ry", 6)
    .style("cursor", d => d.children ? "pointer" : "default")
    .on("mouseover", (event, d) => {
      tooltip.transition().duration(200).style("opacity", 0.95);
      tooltip.html(`<strong>${d.data.name}</strong><br>${d.value ? `Popularity: ${format(d.value)}` : ''}`);
    })
    .on("mousemove", event => {
      tooltip.style("left", (event.pageX + 15) + "px").style("top", (event.pageY - 10) + "px");
    })
    .on("mouseout", () => {
      tooltip.transition().duration(200).style("opacity", 0);
    })
    .on("click", (event, d) => {
      if (d.children && d.children.length > 0) zoomIn(d);
    });

  nodes.append("text")
    .attr("x", 8)
    .attr("y", 18)
    .text(d => {
      const boxWidth = d.x1 - d.x0;
      return boxWidth > 60 ? d.data.name.slice(0, 20) : "";
    })
    .attr("fill", "#fff")
    .style("pointer-events", "none");
}

function zoomIn(d) {
  if (!d.children || d.children.length === 0) return;
  treemap(d);
  svg.transition().duration(600)
    .tween("zoom", () => {
      const x = d3.scaleLinear().domain([d.x0, d.x1]).range([0, width]);
      const y = d3.scaleLinear().domain([d.y0, d.y1]).range([0, height]);

      return t => {
        svg.selectAll("g").attr("transform", node =>
          `translate(${x(node.x0)},${y(node.y0)})`
        );
        svg.selectAll("rect")
          .attr("width", node => x(node.x1) - x(node.x0))
          .attr("height", node => y(node.y1) - y(node.y0));
      };
    });
  currentRoot = d;
  setTimeout(() => render(currentRoot), 600);
}
</script>
{% endblock %}

{% extends 'base.html' %}
{% block content %}
<h2 class="text-3xl font-bold mb-6 text-center text-green-700">Zoomable TreeMap of Singers</h2>
<div id="treemap" class="overflow-x-auto flex justify-center"></div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const data = {{ data | safe }};
const width = 960;
const height = 600;
const format = d3.format(",d");

const color = d3.scaleOrdinal()
  .domain(["Singer"])
  .range(d3.schemeSet3);

const svg = d3.select("#treemap")
  .append("svg")
  .attr("width", width)
  .attr("height", height)
  .style("font-family", "Inter, sans-serif")
  .style("font-size", "12px");

const tooltip = d3.select("body")
  .append("div")
  .style("position", "absolute")
  .style("background", "#000")
  .style("color", "#fff")
  .style("padding", "6px 8px")
  .style("font-size", "12px")
  .style("border-radius", "4px")
  .style("pointer-events", "none")
  .style("opacity", 0);

// Build hierarchy
const root = d3.hierarchy(data).sum(d => d.value).sort((a, b) => b.value - a.value);
const treemap = d3.treemap().size([width, height]).paddingInner(3);
treemap(root);

let currentRoot = root;
render(root);

// Render function
function render(source) {
  svg.selectAll("*").remove(); // clear everything

  const nodes = svg.selectAll("g")
    .data(source.children)
    .join("g")
    .attr("transform", d => `translate(${d.x0},${d.y0})`);

  nodes.append("rect")
    .attr("width", d => d.x1 - d.x0)
    .attr("height", d => d.y1 - d.y0)
    .attr("fill", d => color(d.ancestors().map(d => d.data.name).join("/")))
    .attr("rx", 4)
    .attr("ry", 4)
    .style("cursor", d => d.children ? "pointer" : "default")
    .on("mouseover", (event, d) => {
      tooltip.transition().duration(200).style("opacity", 1);
      tooltip.html(`
        <b>${d.data.name}</b><br>
        ${d.value ? `Popularity: ${format(d.value)}` : ''}
      `);
    })
    .on("mousemove", event => {
      tooltip.style("left", (event.pageX + 15) + "px")
             .style("top", (event.pageY - 10) + "px");
    })
    .on("mouseout", () => {
      tooltip.transition().duration(200).style("opacity", 0);
    })
    .on("click", (event, d) => {
      if (d.children && d.children.length > 0) {
        zoom(d);
      }
    });

  nodes.append("text")
    .attr("x", 6)
    .attr("y", 16)
    .attr("fill", "#fff")
    .text(d => {
      const w = d.x1 - d.x0;
      return w > 60 ? d.data.name.slice(0, 18) : "";
    })
    .style("pointer-events", "none");
}

// Zoom function (fixed)
function zoom(d) {
  treemap(d);
  currentRoot = d;

  svg.transition().duration(500).on("end", () => render(currentRoot));
}
</script>
{% endblock %}

{% extends 'base.html' %}
{% block content %}
<h2 class="text-3xl font-bold mb-6 text-center text-green-700">TreeMap of Singers Playlist</h2>
<div id="treemap" class="flex justify-center"></div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const data = {{ data | safe }};

const width = 900;
const height = 600;
const color = d3.scaleOrdinal(d3.schemeCategory10);

const svg = d3.select("#treemap")
  .append("svg")
  .attr("width", width)
  .attr("height", height);

const root = d3.hierarchy(data)
  .sum(d => d.value)
  .sort((a, b) => b.value - a.value);

d3.treemap()
  .size([width, height])
  .paddingInner(2)
  .round(true)(root);

// Add tooltip
const tooltip = d3.select("body")
  .append("div")
  .style("position", "absolute")
  .style("background", "rgba(0,0,0,0.75)")
  .style("color", "#fff")
  .style("padding", "6px 8px")
  .style("border-radius", "4px")
  .style("font-size", "12px")
  .style("pointer-events", "none")
  .style("opacity", 0);

const nodes = svg
  .selectAll("g")
  .data(root.leaves())
  .enter()
  .append("g")
  .attr("transform", d => `translate(${d.x0},${d.y0})`);

nodes.append("rect")
  .attr("width", d => d.x1 - d.x0)
  .attr("height", d => d.y1 - d.y0)
  .attr("fill", d => color(d.parent.data.name))
  .attr("rx", 4)
  .attr("ry", 4)
  .on("mouseover", (event, d) => {
    tooltip.transition().duration(200).style("opacity", 0.95);
    tooltip.html(
      `<strong>Song:</strong> ${d.data.name}<br>
       <strong>Genre:</strong> ${d.parent.data.name}<br>
       <strong>Artist:</strong> ${d.parent.parent.data.name}<br>
       <strong>Popularity:</strong> ${d.value}`
    );
  })
  .on("mousemove", event => {
    tooltip
      .style("left", event.pageX + 15 + "px")
      .style("top", event.pageY - 10 + "px");
  })
  .on("mouseout", () => {
    tooltip.transition().duration(200).style("opacity", 0);
  });

nodes.append("text")
  .text(d => d.data.name.length > 20 ? d.data.name.slice(0, 17) + "..." : d.data.name)
  .attr("x", 4)
  .attr("y", 14)
  .attr("font-size", "10px")
  .attr("fill", "white");
</script>
{% endblock %}
